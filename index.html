<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game Aprimorado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* =========================================================
           ESTILOS CSS GERAIS E TEMA
           ========================================================= */

        :root {
            /* Tema Escuro (Padrão) */
            --color-primary: #5865F2; /* Azul Discord/Slack */
            --color-primary-hover: #4752C4;
            --color-accent: #1ED760; /* Verde Spotify */
            --color-text: #F6F6F6;
            --color-text-secondary: #AAAAAA;
            --bg-body: #1E1E2E; /* Dark background */
            --bg-container: #2D2D3D; /* Slightly lighter container */
            --bg-screen: #202225; /* Tela de jogo / Menu */
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        .light-mode {
            /* Tema Claro */
            --color-primary: #007bff;
            --color-primary-hover: #0056b3;
            --color-accent: #28a745;
            --color-text: #333333;
            --color-text-secondary: #666666;
            --bg-body: #F0F2F5;
            --bg-container: #FFFFFF;
            --bg-screen: #E0E2E5;
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            background-color: var(--bg-body);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            flex-direction: column;
        }

        /* =========================================================
           CONTAINERS DE TELA E ANIMAÇÕES
           ========================================================= */

        .screen-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            max-height: 900px;
            background-color: var(--bg-container);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            padding: 20px;
            position: relative;
            overflow: hidden;
            display: none; /* Escondido por padrão */
        }

        .menu-screen, .game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background-color: var(--bg-screen);
            border-radius: 15px;
        }

        .settings-screen, .ranking-screen, .help-screen, .about-screen {
            height: 100%;
            overflow-y: auto;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background-color: var(--bg-screen);
            border-radius: 15px;
        }

        /* Classes de Animação */

        /* ------------------ Transição de Saída (Slide Out) ------------------ */
        .tela-saindo {
            animation: slideOutLeft 0.3s ease-in-out forwards;
        }

        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        /* ------------------ Transição de Entrada (Slide In) ------------------ */
        .tela-entrando {
            animation: slideInRight 0.3s ease-in-out forwards;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* =========================================================
           COMPONENTES DO MENU
           ========================================================= */

        h1 {
            color: var(--color-primary);
            margin-bottom: 30px;
            font-size: 3em;
        }

        .menu-buttons button {
            background-color: var(--color-primary);
            color: var(--color-text);
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 10px var(--shadow-color);
            width: 250px;
        }

        .menu-buttons button:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow-color);
        }

        /* =========================================================
           CONFIGURAÇÕES (SETTINGS) E RANKING
           ========================================================= */

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--color-text-secondary);
        }
        
        .setting-item label {
            font-size: 1.1em;
        }

        .ranking-list, .help-content, .about-content {
            margin-top: 20px;
            text-align: left;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dotted var(--color-text-secondary);
        }

        .back-button {
            background-color: var(--color-accent);
            color: var(--bg-body);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
            align-self: flex-start;
        }

        /* =========================================================
           TELA DE JOGO (GAME SCREEN)
           ========================================================= */

        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }

        #gameCanvas {
            border: 5px solid var(--color-primary);
            background-color: var(--bg-screen);
            box-shadow: 0 0 20px var(--shadow-color);
            border-radius: 8px;
        }

        .game-controls button {
            background-color: var(--color-accent);
            color: var(--bg-body);
            border: none;
            padding: 10px 20px;
            margin-top: 15px;
            margin-right: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            box-shadow: 0 3px 8px var(--shadow-color);
        }

        /* =========================================================
           TEMA SWITCH 
           ========================================================= */

        .theme-toggle-wrapper {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        
        .theme-toggle {
            --toggle-size: 1.5em;
            position: relative;
            display: inline-block;
            width: calc(var(--toggle-size) * 2);
            height: var(--toggle-size);
        }
        
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: var(--toggle-size);
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: calc(var(--toggle-size) * 0.8);
            width: calc(var(--toggle-size) * 0.8);
            left: calc(var(--toggle-size) * 0.1);
            bottom: calc(var(--toggle-size) * 0.1);
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--color-primary);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--color-primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(var(--toggle-size));
        }

        .slider-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 4px;
            pointer-events: none;
            color: white;
        }

        .slider-icons .fa-moon { color: var(--color-text); }
        .slider-icons .fa-sun { color: gold; }

        /* =========================================================
           EFEITO DE BOLINHAS CAINDO (Confetes)
           ========================================================= */
        .bolinha {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            bottom: -50px;
            opacity: 0;
            z-index: 9999;
            animation: fallAndFade 0.8s ease-out forwards;
        }

        @keyframes fallAndFade {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

    </style>
</head>
<body>

    <div class="theme-toggle-wrapper">
        <label class="theme-toggle">
            <input type="checkbox" id="themeSwitch">
            <span class="slider">
                 <div class="slider-icons">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                </div>
            </span>
        </label>
    </div>

    <div class="screen-container">
        
        <div class="menu-screen" id="menuScreen" style="display: flex;">
            <h1>SNAKE GAME</h1>
            
            <div class="menu-buttons">
                <button id="btnStartGame"><i class="fas fa-play"></i> INICIAR JOGO</button>
                <button id="btnShowSettings"><i class="fas fa-cog"></i> CONFIGURAÇÕES</button>
                <button id="btnShowRanking"><i class="fas fa-trophy"></i> RANKING</button>
                <button id="btnShowHelp"><i class="fas fa-question-circle"></i> AJUDA</button>
                <button id="btnShowAbout"><i class="fas fa-info-circle"></i> SOBRE</button>
            </div>
        </div>

        <div class="game-screen" id="gameScreen">
            <div class="game-header">
                <div>SCORE: <span id="score">0</span></div>
                <div>HIGHSCORE: <span id="highScore">0</span></div>
                <div>VELOCIDADE: <span id="speed">10.0x</span></div>
            </div>
            
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            
            <div class="game-controls">
                <button id="pauseBtn"><i class="fas fa-pause"></i> PAUSAR</button>
                <button id="resetBtn"><i class="fas fa-redo"></i> RESETAR</button>
                <button id="btnBackGame"><i class="fas fa-arrow-left"></i> VOLTAR AO MENU</button>
            </div>
        </div>
        
        <div class="settings-screen" id="settingsScreen">
            <h2><i class="fas fa-cog"></i> Configurações</h2>
            
            <div class="setting-item">
                <label for="speedSlider">Velocidade do Jogo (ms)</label>
                <input type="range" id="speedSlider" min="50" max="300" step="10">
                <span id="speedValue">100ms</span>
            </div>
            
            <div class="setting-item">
                <label for="sizeSlider">Tamanho do Campo (px)</label>
                <input type="range" id="sizeSlider" min="200" max="600" step="40">
                <span id="sizeValue">400px</span>
            </div>

            <div class="setting-item">
                <label for="snakeColor">Cor da Cobra</label>
                <input type="color" id="snakeColor" value="#5865F2">
            </div>

            <button class="back-button" id="btnSaveSettings"><i class="fas fa-save"></i> Salvar e Aplicar</button>
            <button class="back-button" id="btnBackSettings"><i class="fas fa-arrow-left"></i> Voltar</button>
        </div>
        
        <div class="ranking-screen" id="rankingScreen">
            <h2><i class="fas fa-trophy"></i> Ranking</h2>
            
            <div class="ranking-list" id="rankingList">
                <p>Nenhum recorde encontrado.</p>
            </div>
            
            <button class="back-button" id="btnBackRanking"><i class="fas fa-arrow-left"></i> Voltar</button>
        </div>

        <div class="help-screen" id="helpScreen">
            <h2><i class="fas fa-question-circle"></i> Ajuda</h2>
            <div class="help-content">
                <h3>Controles:</h3>
                <ul>
                    <li>**Teclas de Seta (ou W, A, S, D):** Movem a cobra.</li>
                    <li>**P (ou botão PAUSAR):** Pausa/Despausa o jogo.</li>
                    <li>**R (ou botão RESETAR):** Reinicia o jogo.</li>
                </ul>
                
                <h3>Pontuação:</h3>
                <p>Cada fruta normal (maçã, banana, etc.) vale 1 ponto. A fruta de ouro (Gold) vale 5 pontos.</p>
            </div>
            <button class="back-button" id="btnBackHelp"><i class="fas fa-arrow-left"></i> Voltar</button>
        </div>

        <div class="about-screen" id="aboutScreen">
            <h2><i class="fas fa-info-circle"></i> Sobre</h2>
            <div class="about-content">
                <p>Este é um projeto de Snake Game desenvolvido com foco em uma experiência de usuário moderna, utilizando transições CSS e aprimoramentos visuais no Canvas.</p>
                <p>Desenvolvido para demonstração e aprendizado.</p>
            </div>
            <button class="back-button" id="btnBackAbout"><i class="fas fa-arrow-left"></i> Voltar</button>
        </div>

    </div>

    <script>
        // =========================================================
        // FUNÇÕES AUXILIARES, TEMA E EFEITOS
        // =========================================================

        const themeSwitch = document.getElementById('themeSwitch');
        
        /**
         * Altera a tonalidade de uma cor hexadecimal.
         */
        function shadeColor(color, percent) {
            if (typeof color !== 'string' || color.length !== 7 || color[0] !== '#') {
                return color; 
            }
            
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            R = Math.min(255, Math.max(0, parseInt(R * (100 + percent) / 100)));
            G = Math.min(255, Math.max(0, parseInt(G * (100 + percent) / 100)));
            B = Math.min(255, Math.max(0, parseInt(B * (100 + percent) / 100)));

            let RR = ((R.toString(16).length == 1) ? "0" + R.toString(16) : R.toString(16));
            let GG = ((G.toString(16).length == 1) ? "0" + G.toString(16) : G.toString(16));
            let BB = ((B.toString(16).length == 1) ? "0" + B.toString(16) : B.toString(16));

            return "#" + RR + GG + BB;
        }

        function applyTheme(isLightMode) {
            if (isLightMode) {
                document.body.classList.add('light-mode');
            } else {
                document.body.classList.remove('light-mode');
            }
        }

        function toggleTheme() {
            const isLightMode = themeSwitch.checked;
            applyTheme(isLightMode);
            localStorage.setItem('snakeTheme', isLightMode ? 'light' : 'dark');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('snakeTheme') || 'dark';
            const isLightMode = savedTheme === 'light';

            if(themeSwitch) themeSwitch.checked = isLightMode;
            applyTheme(isLightMode);
        }
        
        function playSound(soundName) {
            // Implementação de som omitida
        }
        
        /**
         * Cria e anima bolinhas caindo (efeito confete) em elementos.
         */
        function criarBolinhasCaindo(numBolinhas = 15, elementoAlvo = null) {
            const colors = [
                getComputedStyle(document.documentElement).getPropertyValue('--color-primary'),
                getComputedStyle(document.documentElement).getPropertyValue('--color-accent'), 
                '#4CAF50', '#FF9800', '#9C27B0'
            ];
            
            const parentElement = document.body;
            
            for (let i = 0; i < numBolinhas; i++) {
                setTimeout(() => {
                    const bolinha = document.createElement('div');
                    bolinha.classList.add('bolinha');
                    
                    let left = Math.random() * 100;
                    
                    if (elementoAlvo) {
                        const rect = elementoAlvo.getBoundingClientRect();
                        const parentWidth = window.innerWidth;
                        const normalizedLeft = (rect.left / parentWidth) * 100;
                        const normalizedWidth = (rect.width / parentWidth) * 100;
                        left = normalizedLeft + (normalizedWidth * Math.random());
                    }
                    
                    bolinha.style.left = left + 'vw';
                    bolinha.style.background = colors[Math.floor(Math.random() * colors.length)];
                    bolinha.style.animationDuration = (0.8 + Math.random() * 0.7) + 's';
                    
                    const tamanho = 10 + Math.random() * 15;
                    bolinha.style.width = tamanho + 'px';
                    bolinha.style.height = tamanho + 'px';
                    
                    parentElement.appendChild(bolinha);
                    
                    bolinha.addEventListener('animationend', () => {
                        if (bolinha.parentNode) {
                            bolinha.parentNode.removeChild(bolinha);
                        }
                    }, { once: true });

                }, i * 50);
            }
        }

        function hideAllScreens() {
            const screens = [
                'menuScreen', 'gameScreen', 'settingsScreen',
                'rankingScreen', 'helpScreen', 'aboutScreen'
            ];

            screens.forEach(screen => {
                const elemento = document.getElementById(screen);
                if (elemento) {
                    elemento.style.display = 'none';
                    elemento.classList.remove('tela-saindo', 'tela-entrando');
                }
            });
        }

        // =========================================================
        // FUNÇÃO DE TRANSIÇÃO ENTRE TELAS (CORRIGIDA COM animationend)
        // =========================================================

        function transicionarTela(telaAtualId, novaTelaId, callback) {
            const telaAtual = document.getElementById(telaAtualId);
            const novaTela = document.getElementById(novaTelaId);
            
            // 1. Caso de animação de saída:
            if (telaAtual && telaAtual.style.display !== 'none' && telaAtualId !== novaTelaId) {
                
                telaAtual.classList.add('tela-saindo');
                
                // Espera a animação de saída terminar
                const onAnimationEnd = () => {
                    telaAtual.removeEventListener('animationend', onAnimationEnd);
                    telaAtual.classList.remove('tela-saindo');
                    
                    // Esconde todas as telas e mostra a nova (passo 2)
                    hideAllScreens();
                    showNewScreen();
                };
                
                telaAtual.addEventListener('animationend', onAnimationEnd, { once: true });
                
            } 
            // 2. Caso de tela inicial ou transição imediata:
            else {
                hideAllScreens();
                showNewScreen();
            }

            // Função interna para mostrar a nova tela
            function showNewScreen() {
                if (novaTela) {
                    novaTela.style.display = (novaTelaId === 'menuScreen' || novaTelaId === 'gameScreen') ? 'flex' : 'block';
                    novaTela.classList.add('tela-entrando');
                    
                    setTimeout(() => {
                        novaTela.classList.remove('tela-entrando');
                    }, 500);
                }
                
                if (callback) callback();
            }
        }

        // =========================================================
        // SISTEMA DE IMAGENS PARA FRUTAS (Assets)
        // =========================================================

        // Tipos de frutas (devem corresponder aos nomes dos arquivos)
        const FRUIT_TYPES = ['apple', 'watermelon', 'banana', 'orange', 'cherry', 'pineapple', 'grape', 'lemon', 'strawberry']; 

        const fruitImages = {
            apple: new Image(),
            banana: new Image(),
            orange: new Image(),
            watermelon: new Image(),
            cherry: new Image(),
            pineapple: new Image(),
            grape: new Image(),
            lemon: new Image(),
            strawberry: new Image(),
            gold: new Image() // Fruta especial
        };

        // USANDO CAMINHOS RELATIVOS (ESPERA-SE QUE A PASTA 'images' EXISTA)
        const fruitImagePaths = {
            apple: 'images/apple.png',
            banana: 'images/banana.png',
            orange: 'images/orange.png',
            watermelon: 'images/watermelon.png',
            cherry: 'images/cherry.png',
            pineapple: 'images/pineapple.png',
            grape: 'images/grape.png',
            lemon: 'images/lemon.png',
            strawberry: 'images/strawberry.png',
            gold: 'images/gold.png'
        };

        // Carregar todas as imagens
        Object.keys(fruitImages).forEach(fruit => {
            fruitImages[fruit].src = fruitImagePaths[fruit];
            fruitImages[fruit].onerror = function() {
                console.error(`Falha ao carregar imagem: ${fruitImages[fruit].src}. Usando fallback.`);
            };
        });

        // =========================================================
        // CONFIGURAÇÕES E RANKING
        // =========================================================
        
        function getDefaultSettings() {
            return {
                speed: 100,
                fieldSize: 400,
                snakeColor: '#5865F2'
            };
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('snakeSettings')) || getDefaultSettings();

            document.getElementById('speedSlider').value = settings.speed;
            document.getElementById('speedValue').textContent = settings.speed + 'ms';
            
            document.getElementById('sizeSlider').value = settings.fieldSize;
            document.getElementById('sizeValue').textContent = settings.fieldSize + 'px';
            
            document.getElementById('snakeColor').value = settings.snakeColor;
            
            document.getElementById('speedSlider').oninput = function() {
                document.getElementById('speedValue').textContent = this.value + 'ms';
            };
            
            document.getElementById('sizeSlider').oninput = function() {
                document.getElementById('sizeValue').textContent = this.value + 'px';
            };
        }

        function saveSettings() {
            const settings = {
                speed: parseInt(document.getElementById('speedSlider').value),
                fieldSize: parseInt(document.getElementById('sizeSlider').value),
                snakeColor: document.getElementById('snakeColor').value
            };
            localStorage.setItem('snakeSettings', JSON.stringify(settings));
            alert('Configurações salvas! Aplique ao iniciar o próximo jogo.');
        }

        function updateRanking(newScore) {
            let ranking = JSON.parse(localStorage.getItem('snakeRanking')) || [];
            
            const newRecord = { score: newScore, date: new Date().toLocaleString() };
            ranking.push(newRecord);

            ranking.sort((a, b) => b.score - a.score);
            ranking = ranking.slice(0, 10);

            localStorage.setItem('snakeRanking', JSON.stringify(ranking));

            const currentHighScore = parseInt(localStorage.getItem('snakeHighScore') || 0);
            if (newScore > currentHighScore) {
                localStorage.setItem('snakeHighScore', newScore);
                document.getElementById('highScore').textContent = newScore;
            }
        }

        function loadRanking() {
            const rankingListDiv = document.getElementById('rankingList');
            const ranking = JSON.parse(localStorage.getItem('snakeRanking')) || [];
            rankingListDiv.innerHTML = '';

            if (ranking.length === 0) {
                rankingListDiv.innerHTML = '<p>Nenhum recorde ainda. Comece a jogar!</p>';
                return;
            }

            ranking.forEach((item, index) => {
                const rankItem = document.createElement('div');
                rankItem.classList.add('ranking-item');
                rankItem.innerHTML = `
                    <span>#${index + 1}</span>
                    <span>Score: ${item.score}</span>
                    <span style="font-size: 0.8em; color: var(--color-text-secondary);">${item.date}</span>
                `;
                rankingListDiv.appendChild(rankItem);
            });
        }
        
        // =========================================================
        // JOGO (Snake) - Variáveis e Funções Principais
        // =========================================================

        let canvas, ctx;
        let snake = [];
        let food = {};
        let direction = 'right';
        let nextDirection = 'right';
        let score = 0;
        let highScore = 0;
        let gameSpeed = 100;
        let gameRunning = true;
        let gameLoop;
        let gameTick = 0; 

        function initGame() {
            const settings = JSON.parse(localStorage.getItem('snakeSettings')) || getDefaultSettings();

            canvas = document.getElementById('gameCanvas');
            canvas.width = settings.fieldSize;
            canvas.height = settings.fieldSize;
            ctx = canvas.getContext('2d');

            snake = [{ x: 10, y: 10 }];
            direction = 'right';
            nextDirection = 'right';
            score = 0;
            gameSpeed = settings.speed;
            gameRunning = true;
            gameTick = 0;

            highScore = localStorage.getItem('snakeHighScore') || 0;
            document.getElementById('highScore').textContent = highScore;
            document.getElementById('score').textContent = score;
            document.getElementById('speed').textContent = (1000 / gameSpeed).toFixed(1) + 'x';
            
            document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> PAUSAR';

            generateFood();
            draw();

            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(update, gameSpeed);

            document.removeEventListener('keydown', handleKeyPress);
            document.addEventListener('keydown', handleKeyPress);
        }
        
        function generateFood() {
            const segmentSize = 20;
            const max = canvas.width / segmentSize;
            
            let newFood;
            
            do {
                const isSpecial = Math.random() > 0.8;
                let chosenFruitType = isSpecial ? 'gold' : FRUIT_TYPES[Math.floor(Math.random() * FRUIT_TYPES.length)];
                
                newFood = {
                    x: Math.floor(Math.random() * max),
                    y: Math.floor(Math.random() * max),
                    type: isSpecial ? 'special' : 'normal',
                    fruitType: chosenFruitType
                };
            } while (snake.some(segment => segment.x === newFood.x && segment.y === newFood.y));
            
            food = newFood;
        }

        function update() {
            if (!gameRunning) return;
            
            gameTick++;
            direction = nextDirection;
            
            const head = { x: snake[0].x, y: snake[0].y };
            
            if (direction === 'right') head.x++;
            else if (direction === 'left') head.x--;
            else if (direction === 'up') head.y--;
            else if (direction === 'down') head.y++;
            
            const gridSize = 20;
            const max = canvas.width / gridSize;
            
            if (head.x < 0 || head.x >= max || 
                head.y < 0 || head.y >= max || 
                snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                
                gameOver();
                return;
            }
            
            snake.unshift(head);
            
            if (head.x === food.x && head.y === food.y) {
                const points = food.type === 'special' ? 5 : 1;
                score += points;
                document.getElementById('score').textContent = score;
                
                if (score > highScore) {
                    highScore = score;
                    document.getElementById('highScore').textContent = highScore;
                }
                
                generateFood();
                playSound('eat');
            } else {
                snake.pop();
            }
            
            draw();
        }

        function handleKeyPress(e) {
            if (!gameRunning) {
                if (e.key === 'p' || e.key === 'P') togglePause();
                return;
            }
            
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                if (direction !== 'left') nextDirection = 'right';
            } else if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                if (direction !== 'right') nextDirection = 'left';
            } else if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                if (direction !== 'down') nextDirection = 'up';
            } else if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                if (direction !== 'up') nextDirection = 'down';
            } else if (e.key === 'p' || e.key === 'P') {
                togglePause();
            } else if (e.key === 'r' || e.key === 'R') {
                resetGame();
            }
        }

        function togglePause() {
            if (gameRunning) {
                clearInterval(gameLoop);
                gameRunning = false;
                document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-play"></i> CONTINUAR';
            } else {
                gameLoop = setInterval(update, gameSpeed);
                gameRunning = true;
                document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> PAUSAR';
            }
        }

        function resetGame() {
            if (gameLoop) clearInterval(gameLoop);
            initGame();
        }
        
        function gameOver() {
            gameRunning = false;
            clearInterval(gameLoop);
            
            updateRanking(score);
            
            document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-gamepad"></i> JOGAR NOVAMENTE';
            alert(`GAME OVER! Sua pontuação: ${score}`);
        }
        
        /**
         * Função de desenho principal, incluindo a renderização de imagens das frutas.
         */
        function draw() {
            // 1. Desenha o fundo
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-screen');
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const baseColor = document.getElementById('snakeColor').value || '#5865F2';
            const darkColor = shadeColor(baseColor, -20);
            const segmentSize = 20;
            
            const amplitude = 1.5; 
            const frequency = 0.5;
            const speed = 0.2;
            
            // Função auxiliar para desenhar cantos arredondados
            const drawRoundedRect = (color, rectX, rectY, width, height, r) => {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(rectX + r, rectY);
                ctx.lineTo(rectX + width - r, rectY);
                ctx.arcTo(rectX + width, rectY, rectX + width, rectY + r, r);
                ctx.lineTo(rectX + width, rectY + height - r);
                ctx.arcTo(rectX + width, rectY + height, rectX + width - r, rectX + height, r);
                ctx.lineTo(rectX + r, rectY + height);
                ctx.arcTo(rectX, rectY + height, rectX, rectY + height - r, r);
                ctx.lineTo(rectX, rectY + r);
                ctx.arcTo(rectX, rectY, rectX + r, rectY, r);
                ctx.closePath();
                ctx.fill();
            };

            // 2. Desenho da Cobra
            snake.forEach((segment, index) => {
                const x = segment.x * segmentSize;
                let y = segment.y * segmentSize;
                const radius = 3; 
                
                let offsetY = 0;
                if (index > 0) {
                    const angle = gameTick * speed + index * frequency;
                    offsetY = amplitude * Math.sin(angle);
                    y += offsetY; 
                }
                
                if (index > 0) {
                    drawRoundedRect(darkColor, x, y, segmentSize, segmentSize, radius);
                    drawRoundedRect(baseColor, x + 2, y + 2, segmentSize - 4, segmentSize - 4, radius);
                } 
                else {
                    ctx.fillStyle = baseColor;
                    ctx.fillRect(x - 1, y - 1, segmentSize + 2, segmentSize + 2); 
                    ctx.fillStyle = darkColor;
                    ctx.fillRect(x, y, segmentSize, segmentSize); 
                    
                    // Olhos
                    ctx.fillStyle = 'black';
                    const eyeSize = 2;
                    if (direction === 'right') {
                        ctx.fillRect(x + 13, y + 3, eyeSize, eyeSize);
                        ctx.fillRect(x + 13, y + 13, eyeSize, eyeSize);
                    } else if (direction === 'left') {
                        ctx.fillRect(x + 5, y + 3, eyeSize, eyeSize);
                        ctx.fillRect(x + 5, y + 13, eyeSize, eyeSize);
                    } else if (direction === 'up') {
                        ctx.fillRect(x + 3, y + 5, eyeSize, eyeSize);
                        ctx.fillRect(x + 15, y + 5, eyeSize, eyeSize);
                    } else if (direction === 'down') {
                        ctx.fillRect(x + 3, y + 15, eyeSize, eyeSize);
                        ctx.fillRect(x + 15, y + 15, eyeSize, eyeSize);
                    }
                }
            });

            // 3. Desenho das Frutas com IMAGENS
            const foodX = food.x * segmentSize;
            const foodY = food.y * segmentSize;
            const fruitType = food.fruitType;
            
            if (fruitImages[fruitType] && fruitImages[fruitType].complete && fruitImages[fruitType].naturalWidth > 0) {
                const imgSize = segmentSize * 1.2;
                const offset = (imgSize - segmentSize) / 2;
                
                ctx.drawImage(
                    fruitImages[fruitType],
                    foodX - offset,
                    foodY - offset,
                    imgSize,
                    imgSize
                );
                
                // Brilho especial para frutas especiais (Ex: gold)
                if (food.type === 'special') {
                    ctx.save();
                    ctx.globalAlpha = 0.3;
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(foodX + segmentSize/2, foodY + segmentSize/2, segmentSize/2 + 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            } else {
                // Fallback: desenho geométrico simples
                const foodCenterX = foodX + segmentSize / 2;
                const foodCenterY = foodY + segmentSize / 2;
                const radiusFood = 8;
                
                ctx.fillStyle = food.type === 'special' ? 'gold' : 'red';
                ctx.beginPath();
                ctx.arc(foodCenterX, foodCenterY, radiusFood, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#800000';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }


        // =========================================================
        // LISTENERS GERAIS E INICIALIZAÇÃO
        // =========================================================

        function setupEventListeners() {
            if(document.getElementById('themeSwitch')) {
                document.getElementById('themeSwitch').addEventListener('change', toggleTheme);
            }
            
            // --- Botões do Menu ---
            document.getElementById('btnStartGame').addEventListener('click', function() {
                criarBolinhasCaindo(20, this);
                transicionarTela('menuScreen', 'gameScreen', initGame);
            });
            
            document.getElementById('btnShowSettings').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('menuScreen', 'settingsScreen', loadSettings);
            });
            
            document.getElementById('btnShowRanking').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('menuScreen', 'rankingScreen', loadRanking);
            });
            
            document.getElementById('btnShowHelp').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('menuScreen', 'helpScreen');
            });
            
            document.getElementById('btnShowAbout').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('menuScreen', 'aboutScreen');
            });
            
            // --- Botões Voltar ---
            document.getElementById('btnBackGame').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('gameScreen', 'menuScreen', function() {
                    if (gameLoop) clearInterval(gameLoop);
                    gameRunning = false;
                });
            });
            
            document.getElementById('btnBackSettings').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('settingsScreen', 'menuScreen');
            });
            
            document.getElementById('btnBackRanking').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('rankingScreen', 'menuScreen');
            });
            
            document.getElementById('btnBackHelp').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('helpScreen', 'menuScreen');
            });
            
            document.getElementById('btnBackAbout').addEventListener('click', function() {
                criarBolinhasCaindo(15, this);
                transicionarTela('aboutScreen', 'menuScreen');
            });
            
            // Botões do jogo e salvar configurações
            if(document.getElementById('pauseBtn')) document.getElementById('pauseBtn').addEventListener('click', togglePause);
            if(document.getElementById('resetBtn')) document.getElementById('resetBtn').addEventListener('click', resetGame);
            
            if(document.getElementById('btnSaveSettings')) {
                document.getElementById('btnSaveSettings').addEventListener('click', function() {
                    criarBolinhasCaindo(10, this);
                    saveSettings(); 
                });
            }
        }

        // Inicialização ao carregar a página
        window.onload = function() {
            loadTheme();
            setupEventListeners();
            hideAllScreens();
            document.getElementById('menuScreen').style.display = 'flex';
        };

    </script>
</body>
</html>

